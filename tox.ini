[tox]
envlist = py35, docs, lint
skipsdist = True
toxworkdir={env:TOX_WORK_DIR:.tox}

[testenv]
deps =
  {env:CI_DEPS:}
  -rrequirements.txt
passenv = CODECOV_TOKEN CI CI_* TRAVIS TRAVIS_* APPVEYOR APPVEYOR_*
setenv = HOME = {envtmpdir}
commands =
  mitmdump --sysinfo
  py.test --timeout 60 {posargs}
  {env:CI_COMMANDS:python -c ""}

[testenv:docs]
changedir = docs
commands = sphinx-build -W -b html -d {envtmpdir}/doctrees . {envtmpdir}/html

[testenv:lint]
commands =
  mitmdump --sysinfo
  flake8 --jobs 8 --count mitmproxy pathod examples test
  rstcheck README.rst
  mypy --silent-imports \
    mitmproxy/addons \
    mitmproxy/addonmanager.py \
    mitmproxy/proxy/protocol/ \
    mitmproxy/log.py \
    mitmproxy/tools/dump.py mitmproxy/tools/web

[testenv:wheel]
basepython = python3.5
recreate = True
skip_install = True
deps =
  -rrequirements.txt
commands =
  python ./setup.py -q bdist_wheel --dist-dir build

[testenv:wheel-test]
basepython = python3.5
recreate = True
skip_install = True
deps =
  build/mitmproxy-0.19-py3-none-any.whl
commands =
  mitmproxy --version
  mitmdump --version
  mitmweb --version
  pathod --version
  pathoc --version

[testenv:bdist]
basepython = python3.5
recreate = True
skip_install = True
deps =
  git+https://github.com/pyinstaller/pyinstaller.git@483c819d6a256b58db6740696a901bd41c313f0c
  build/mitmproxy-0.19-py3-none-any.whl
commands =
  pyinstaller --clean --workpath build/pyinstaller --distpath build/binaries --additional-hooks-dir release/hooks --onefile --console --icon icon.ico --exclude-module mitmproxy.tools.web --exclude-module mitmproxy.tools.console release/specs/mitmproxy
  pyinstaller --clean --workpath build/pyinstaller --distpath build/binaries --additional-hooks-dir release/hooks --onefile --console --icon icon.ico --exclude-module mitmproxy.tools.web release/specs/mitmdump
  pyinstaller --clean --workpath build/pyinstaller --distpath build/binaries --additional-hooks-dir release/hooks --onefile --console --icon icon.ico --exclude-module mitmproxy.tools.web --exclude-module mitmproxy.tools.console release/specs/mitmweb
  pyinstaller --clean --workpath build/pyinstaller --distpath build/binaries --additional-hooks-dir release/hooks --onefile --console --icon icon.ico --exclude-module mitmproxy.tools.web --exclude-module mitmproxy.tools.console release/specs/pathod
  pyinstaller --clean --workpath build/pyinstaller --distpath build/binaries --additional-hooks-dir release/hooks --onefile --console --icon icon.ico --exclude-module mitmproxy.tools.web --exclude-module mitmproxy.tools.console release/specs/pathoc

[testenv:upload]
basepython = python3.5
recreate = True
skip_install = True
deps =
  click>=6.2, <7.0
  twine>=1.6.5, <1.9
  virtualenv>=14.0.5, <15.2
  wheel>=0.29.0, <0.30
  pysftp==0.2.8
commands = release/rtool.py upload-snapshot --bdist
